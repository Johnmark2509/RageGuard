<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rage Guard</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
    <link rel="manifest" href="/static/site.webmanifest">
</head>

<body>
    <audio id="calmingAudio" src="/static/calming.mp3" preload="auto" loop></audio>

    <div id="welcome-slide" class="slide">
        <img src="/static/rage-guard-logo.jpg" alt="Rage Guard Logo" class="logo">
        <h2 class="subtitle">Check Your Road Rage Level</h2>
        <img src="/static/camera-car-icon.png" alt="Camera Icon" class="icon">
        <p class="description">Take a quick selfie to assess your emotional state before driving.</p>
        <button onclick="openCamera()" class="primary-btn">üì∏ Capture My Mood</button>
        <button onclick="showTips()" class="primary-btn">üìö Read Calming Tips</button>
    </div>

    <div id="result-slide" class="slide hidden">
        <img src="/static/rage-guard-logo.jpg" alt="Rage Guard Logo" class="logo">
        <h2 class="subtitle">Rage Level Detected</h2>
        <div id="videoContainer">
            <video id="videoFeed" autoplay muted playsinline class="photo" style="width: 400px; height: 300px;"></video>
        </div>
        <p id="liveEmotion" class="alert">Detecting...</p>
        <p id="rageAlert" class="description hidden">Road rage detected! Let's help you cool off before you drive.</p>
        <button onclick="showTips()" class="primary-btn">üìö Read Calming Tips</button>
        <button onclick="goBackHome()" class="secondary-btn">üè† Go Back to Home Screen</button>
    </div>

    <div id="tipsModal" class="modal hidden">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3>Read Calming Tips</h3>
            <ul>
                <li><a href="https://www.drivesafecolorado.com/blog/drivers-street-smarts/how-to-handle-road-rage-and-manage-your-emotions" target="_blank">How to Control Road Rage</a></li>
                <li><a href="https://www.verywellmind.com/how-to-manage-and-prevent-road-rage-3145193" target="_blank">How to Manage Road Rage</a></li>
            </ul>
        </div>
    </div>

    <div id="calmTechniques" class="modal hidden">
        <div class="modal-content">
            <h3>Calming Techniques</h3>
            <ul>
                <li>üßò Deep Breathing: Inhale slowly, exhale gently.</li>
                <li>üßò‚Äç‚ôÇÔ∏è Mindfulness: Focus on breathing and staying present.</li>
                <li>üèÉ Light Activity: Stretch or walk calmly.</li>
                <li>üß† Positive Thinking: "This anger will pass."</li>
            </ul>
        </div>
    </div>

    <script>
        let pollingInterval = null;
        let videoStream = null;
        let canvas = null;
        let ctx = null;
        let frameCaptureInterval = null;

        async function openCamera() {
            document.getElementById('welcome-slide').classList.add('hidden');
            document.getElementById('result-slide').classList.remove('hidden');

            try {
                const videoElement = document.getElementById('videoFeed');
                videoStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });

                // üîá Mute the audio tracks so user doesn't hear themselves
                videoStream.getAudioTracks().forEach(track => {
                    track.enabled = false;
                });

                videoElement.srcObject = videoStream;
                await videoElement.play();
                startFrameCapture(videoElement);
                startEmotionPolling();
            } catch (err) {
                console.error("Failed to access camera:", err);
            }
        }

        function startFrameCapture(videoElement) {
    canvas = document.createElement('canvas');
    ctx = canvas.getContext('2d');
    frameCaptureInterval = setInterval(async () => {
        if (videoElement.readyState >= 2) {
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;

            // Apply light denoising (blur) before drawing
            ctx.filter = 'blur(1px)';
            ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
            ctx.filter = 'none'; // Reset filter immediately after drawing

            // Apply gamma correction to brighten the image
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            const gamma = 1.2; // Light gamma correction
            const invGamma = 1 / gamma;

            for (let i = 0; i < data.length; i += 4) {
                data[i] = 255 * Math.pow(data[i] / 255, invGamma);     // Red
                data[i + 1] = 255 * Math.pow(data[i + 1] / 255, invGamma); // Green
                data[i + 2] = 255 * Math.pow(data[i + 2] / 255, invGamma); // Blue
                // Alpha (data[i+3]) stays the same
            }
            ctx.putImageData(imageData, 0, 0);

            // Upload the processed frame
            const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg'));
            const formData = new FormData();
            formData.append('file', blob, 'frame.jpg');
            try {
                await fetch('/analyze_frame', {
                    method: 'POST',
                    body: formData
                });
            } catch (error) {
                console.error("Frame upload error:", error);
            }
        }
    }, 1000); // Capture every 1 second
}

        function startEmotionPolling() {
            pollingInterval = setInterval(async () => {
                try {
                    const response = await fetch('/emotion_live');
                    const data = await response.json();
                    document.getElementById("liveEmotion").textContent = "Detected: " + data.emotion;

                    if (data.is_angry) {
                        document.getElementById("rageAlert").classList.remove('hidden');
                        const audio = document.getElementById("calmingAudio");
                        if (audio.paused) {
                            audio.play();
                        }
                        document.getElementById("calmTechniques").classList.remove('hidden');
                    }
                } catch (error) {
                    console.error("Polling error:", error);
                }
            }, 1000);
        }

        function goBackHome() {
            if (pollingInterval) clearInterval(pollingInterval);
            if (frameCaptureInterval) clearInterval(frameCaptureInterval);
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }

            // Fade out calming audio if playing
            const audio = document.getElementById("calmingAudio");
            if (!audio.paused) {
                let fadeOut = setInterval(() => {
                    if (audio.volume > 0.1) {
                        audio.volume -= 0.1;
                    } else {
                        clearInterval(fadeOut);
                        audio.pause();
                        audio.currentTime = 0;
                        audio.volume = 1.0;
                        window.location.href = "/";
                    }
                }, 200);
            } else {
                window.location.href = "/";
            }
        }

        function showTips() {
            document.getElementById("tipsModal").classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById("tipsModal").classList.add('hidden');
            document.getElementById("calmTechniques").classList.add('hidden');
        }

        window.onclick = function (event) {
    	const modal = document.getElementById("tipsModal");
    	const calmModal = document.getElementById("calmTechniques");

    	    if (event.target === modal) {
        	modal.classList.add('hidden');
    	    }
    	    if (event.target === calmModal) {
        	calmModal.classList.add('hidden');
            }
	}
    </script>

</body>
</html>
