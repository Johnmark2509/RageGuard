<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Rage Guard</title>
</head>
<body>
    <h1>Rage Guard</h1>

    <video id="video" width="640" height="480" autoplay muted></video>
    <p id="emotion">Detecting...</p>

    <script>
    let pollingInterval = null;
    let rageCounter = 0;
    let rageAlertShown = false;
    let calmingTimer = null;
    let videoStream = null;
    let videoElement = null;
    let canvas = null;
    let ctx = null;

    async function openCamera() {
        document.getElementById('welcome-slide').classList.add('hidden');
        document.getElementById('result-slide').classList.remove('hidden');

        // Initialize video streaming
        videoElement = document.createElement('video');
        videoElement.setAttribute('autoplay', '');
        videoElement.setAttribute('muted', '');
        videoElement.setAttribute('playsinline', '');
        videoElement.style.width = "400px";
        videoElement.style.height = "300px";

        document.getElementById('videoFeed').replaceWith(videoElement);

        try {
            videoStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
            videoElement.srcObject = videoStream;
            startFrameCapture();
            startEmotionPolling();
        } catch (err) {
            console.error("Failed to start camera:", err);
        }
    }

    function startFrameCapture() {
        canvas = document.createElement('canvas');
        ctx = canvas.getContext('2d');

        setInterval(async () => {
            if (!videoElement || videoElement.readyState !== 4) return;
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);

            const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg'));
            const formData = new FormData();
            formData.append('file', blob, 'frame.jpg');

            await fetch('/analyze_frame', {
                method: 'POST',
                body: formData
            });
        }, 2000);
    }

    function goBackHome() {
        stopEmotionPolling();
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
        }
        window.location.href = "/";
    }

    function startEmotionPolling() {
        if (pollingInterval) clearInterval(pollingInterval);
        pollingInterval = setInterval(async () => {
            try {
                const response = await fetch("/emotion_live");
                const data = await response.json();
                const emotionText = data.emotion;
                const isAngry = data.is_angry;

                document.getElementById("liveEmotion").textContent = "Detected: " + emotionText;

                if (isAngry) {
                    rageCounter++;
                    if (rageCounter >= 5 && !rageAlertShown) {
                        document.getElementById("rageAlert").classList.remove('hidden');
                        rageAlertShown = true;
                        const audio = document.getElementById("calmingAudio");
                        audio.volume = 0.0;
                        audio.play();
                        let fadeIn = setInterval(() => {
                            if (audio.volume < 0.9) {
                                audio.volume += 0.1;
                            } else {
                                clearInterval(fadeIn);
                                audio.volume = 1.0;
                            }
                        }, 200);
                        document.getElementById("calmTechniques").classList.remove('hidden');
                        if (calmingTimer) clearTimeout(calmingTimer);
                        calmingTimer = setTimeout(showHotlineModal, 30 * 60 * 1000);
                    }
                } else {
                    rageCounter = 0;
                    rageAlertShown = false;
                    clearTimeout(calmingTimer);
                }

            } catch (error) {
                console.error("Failed to fetch emotion:", error);
            }
        }, 1000);
    }

    function stopEmotionPolling() {
        if (pollingInterval) clearInterval(pollingInterval);
        pollingInterval = null;
    }

    function showHotlineModal() {
        alert("Your tension hasn't reduced after 30 minutes. Please consider contacting a mental health professional:\n\nðŸ“ž NCMH: 1553 or 0917-899-8727\nðŸ“ž HOPELINE: (02) 8804-4673");
    }

    function showTips() {
        document.getElementById("tipsModal").style.display = "block";
    }

    function closeModal() {
        document.getElementById("tipsModal").style.display = "none";
        document.getElementById("calmTechniques").style.display = "none";
    }

    window.onclick = function (event) {
        const modal = document.getElementById("tipsModal");
        const calmModal = document.getElementById("calmTechniques");
        if (event.target === modal) {
            modal.style.display = "none";
        }
        if (event.target === calmModal) {
            calmModal.style.display = "none";
        }
    }
</script>
</body>
</html>
