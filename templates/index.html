<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rage Guard</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
    <link rel="manifest" href="/static/site.webmanifest">
</head>

<body>
    <audio id="calmingAudio" src="/static/calming.mp3" preload="auto" loop></audio>

    <div id="welcome-slide" class="slide">
        <img src="/static/rage-guard-logo.jpg" alt="Rate Guard" class="logo">
        <h2 class="subtitle">Check Your Road Rage Level</h2>
        <img src="/static/camera-car-icon.png" alt="Car with camera icon" class="icon">
        <p class="description">Take a quick selfie to assess your emotional state before driving.</p>
        <button onclick="openCamera()" class="primary-btn">ğŸ“¸ Capture My Mood</button>
        <button onclick="showTips()" class="primary-btn">ğŸ“š Read Calming Tips</button><br>
    </div>

    <div id="result-slide" class="slide hidden">
        <img src="/static/rage-guard-logo.jpg" alt="Rate Guard" class="logo">
        <h2 class="subtitle">Rage Level Detected</h2>
        <img id="videoFeed" src="" alt="Live Feed" class="photo" style="width: 400px; height: 300px;">
        <p id="liveEmotion" class="alert">Detecting...</p>
        <p id="rageAlert" class="description hidden">Road rage detected!<br>Let's help you cool off before you drive.</p>
        <button onclick="showTips()" class="primary-btn">ğŸ“š Read Calming Tips</button><br>
        <button onclick="goBackHome()" class="secondary-btn">ğŸ  Go Back to Home Screen</button>
    </div>

    <div id="tipsModal" class="modal hidden">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3>Read Calming Tips</h3>
            <ul>
                <li><a href="https://www.drivesafecolorado.com/blog/drivers-street-smarts/how-to-handle-road-rage-and-manage-your-emotions" target="_blank">How to Control Road Rage and Manage Your Emotions</a></li>
                <li><a href="https://www.verywellmind.com/how-to-manage-and-prevent-road-rage-3145193" target="_blank">How to Manage Feelings of Road Rage</a></li>
            </ul>
        </div>
    </div>

    <div id="calmTechniques" class="modal hidden">
        <div class="modal-content">
            <h3>Calming Techniques</h3>
            <ul>
                <li>ğŸ§˜ Deep Breathing: Inhale slowly, exhale gently for 5 minutes.</li>
                <li>ğŸ§˜â€â™‚ï¸ Mindfulness: Focus on your breathing and stay present.</li>
                <li>ğŸƒ Light Activity: Stretch, or walk around calmly.</li>
                <li>ğŸ§  Positive Thinking: Remind yourself "This anger will pass."</li>
            </ul>
        </div>
    </div>

    <script>
        let pollingInterval = null;
        let rageCounter = 0;
        let rageAlertShown = false;
        let calmingTimer = null;

        function openCamera() {
            document.getElementById('welcome-slide').classList.add('hidden');
            document.getElementById('result-slide').classList.remove('hidden');
            document.getElementById('videoFeed').src = "/video_feed";
            startEmotionPolling();
        }

        function goBackHome() {
            stopEmotionPolling();
            document.getElementById('videoFeed').src = '';
            const audio = document.getElementById("calmingAudio");
            let fadeOut = setInterval(() => {
                if (audio.volume > 0.1) {
                    audio.volume -= 0.1;
                } else {
                    clearInterval(fadeOut);
                    audio.pause();
                    audio.currentTime = 0;
                    audio.volume = 1.0;
                }
            }, 200);
            window.location.href = "/";
        }

        function startEmotionPolling() {
            if (pollingInterval) clearInterval(pollingInterval);
            pollingInterval = setInterval(async () => {
                try {
                    const response = await fetch("/emotion_live");
                    const data = await response.json();
                    const emotionText = data.emotion;
                    const isAngry = data.is_angry;

                    document.getElementById("liveEmotion").textContent = "Detected: " + emotionText;

                    if (isAngry) {
                        rageCounter++;
                        if (rageCounter >= 5 && !rageAlertShown) {
                            document.getElementById("rageAlert").classList.remove('hidden');
                            rageAlertShown = true;
                            const audio = document.getElementById("calmingAudio");
                            audio.volume = 0.0;
                            audio.play();
                            let fadeIn = setInterval(() => {
                                if (audio.volume < 0.9) {
                                    audio.volume += 0.1;
                                } else {
                                    clearInterval(fadeIn);
                                    audio.volume = 1.0;
                                }
                            }, 200);
                            document.getElementById("calmTechniques").classList.remove('hidden');
                            if (calmingTimer) clearTimeout(calmingTimer);
                            calmingTimer = setTimeout(showHotlineModal, 30 * 60 * 1000);
                        }
                    } else {
                        rageCounter = 0;
                        rageAlertShown = false;
                        clearTimeout(calmingTimer);
                    }

                } catch (error) {
                    console.error("Failed to fetch emotion:", error);
                }
            }, 1000);
        }

        function stopEmotionPolling() {
            if (pollingInterval) clearInterval(pollingInterval);
            pollingInterval = null;
        }

        function showHotlineModal() {
            alert("Your tension hasn't reduced after 30 minutes. Please consider contacting a mental health professional:\n\nğŸ“ NCMH: 1553 or 0917-899-8727\nğŸ“ HOPELINE: (02) 8804-4673");
        }

        function showTips() {
            document.getElementById("tipsModal").style.display = "block";
        }

        function closeModal() {
            document.getElementById("tipsModal").style.display = "none";
            document.getElementById("calmTechniques").style.display = "none";
        }

        window.onclick = function (event) {
            const modal = document.getElementById("tipsModal");
            const calmModal = document.getElementById("calmTechniques");
            if (event.target === modal) {
                modal.style.display = "none";
            }
            if (event.target === calmModal) {
                calmModal.style.display = "none";
            }
        }
    </script>
</body>

</html>
